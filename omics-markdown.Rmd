---
title: "â€˜Omics Project"
author: "Aeriel Belk, Amanda Walz, Rebecca Cheek, Kyle Root"
date: "11/27/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is an R-markdown we can use!!

Steps: 

1. import and early explore data
2. then, see what analyses we can do

```{r}
library(readr)
library(stringr)
wn_meta<- read.csv("metadata/metadata.csv")
```
 

Ideas for us to look at. 
Aeriel: Build a phylogenetic tree using Bioconductor(phyloseq) to look at divergence and host species
Kyle:Compare genetic viersity between host species and vecotr species
Amanda: sf plot to use lat-long data and group smilar sequences by region
Rebecca: Landscape genetics approach to look at how the urban vs. rural affects genetic structure or rate of gene flow (see https://doi.org/10.1111/mec.14783). Maybe use popualtion density in each county as a proxy for urbanization.  


Do some analysis of the metadata:

 - species 
 - latitude/longitude
 - distribution over counties
 - sequence similarities/ density by region
 
```{r libraries, message=FALSE, warning=FALSE}
library(seqinr)
library(purrr)
library(dplyr)
library(readr)
library(phyloseq)
library(stringr)
library(tidyr)
library(lubridate)
library(forcats)
library(tigris)
library(knitr)
library(ggplot2)

# if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install("Biostrings", versilibrary(devtools)
on = "3.8"
library(Biostrings)

```

``` {r metadata}
metadata_url <- paste0("https://raw.githubusercontent.com/aeriel-belk/NSCI535-westnile-omics/master/metadata/metadata.csv")

metadataframe <- read_csv(metadata_url)
metadataframe <- metadataframe%>% 
  rename_all(tolower)

```

 
```{r genomics}


```

steps to read in:
1) list.files with full names option to get names of all files in folder, save in object (char vector)
2) pipe that vector into map function that does read.fasta (play around with just the first file first)
3) result should be a long list

seqinr -> read.fasta

```{r read-in}
#1) list files into vector
files <- list.files(path = 'consensus_sequences', full.names = TRUE)

#2) make map function to read in fasta files
#fasta <- map(.x = files, .f = read.fasta, 
#             as.string = TRUE, forceDNAtolower = FALSE)

fasta2 <- readDNAStringSet(files, format="fasta", nrec=-1L, skip=0L, seek.first.rec=FALSE, use.names=TRUE)

writeXStringSet(fasta2, 'consensus-seqs.fna')
#writeXStringSet(LargeDNAStringSet, 'fname.fa')
#write.fasta(sequences, names, file.out, open = "w", nbchar = 60, as.string = FALSE)
```


### Align Sequences
  
Using BioStrings (https://bioconductor.org/packages/release/bioc/html/Biostrings.html) to align sequences so we can compare across samples. Plan is to align, then try to cluster the sequences into groups based on similarity. This will allow us to build trees, which we can try to apply to Amanda and Rebecca's analyses of season and population, as well as host species.
  
```{r biostrings}


```


*Amanda tenative plan to make an interactive map characterizing WNV infections by season, species*

```{r mapped_plot}

#Tidy data for county map with infections by season
ca_wnv <- metadataframe %>% 
  select("species", "collection date",
           "county", "latitude", "longitude") %>% 
  rename_all(funs(str_replace(., "\\s", "_"))) %>% 
  separate(col = collection_date, 
           into = c("month", "day", "year"),
           sep = "/") %>% 
  mutate(month = factor(month),
         season = fct_collapse(month,
               winter = c("12", "1", "2"),
               spring = c("3", "4", "5"),
               summer = c("6", "7", "8"),
               fall = c("9", "10", "11")))

season_summary <- ca_wnv %>% 
  group_by(season) %>% 
  summarize(no_infections = n())
kable(season_summary)

#Creating CA sf boundaries
ca_counties <- counties(state = "CA", cb = TRUE, class = "sf")
ggplot() +
  geom_sf(data = ca_counties)
```
  After getting it important and *roughly* in a usable format, I tried doing some alignment and clustering with the biostrings package
  
```{r biostring, eval=FALSE}
sdist <- stringDist(as(fasta2,"DNAStringSet"), method="hamming")
clust <- hclust(fasta2, method = "single")

sdist <- stringDist()


```

```{r}
#### Rebecca trying to make life easier by using census data per county as a proxy for urbanization
library(tidyr)
library(tidycensus) ##tidycensus package

census_api_key("a22c251a387f5312b9e5c2e5ad21494088e984f6")


```



